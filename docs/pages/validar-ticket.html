<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <title>Guia RQ ‚Äî Verifica√ß√£o de Ticket</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <meta name="color-scheme" content="light">
    <!-- Meta Pixel Code -->
    <script>
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        fbq('init', '2077347819667134');
        fbq('track', 'PageView');
    </script>
    <noscript><img height="1" width="1" style="display:none"
                   src="https://www.facebook.com/tr?id=2077347819667134&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
</head>

<body class="bg-gray-100 min-h-screen">
<!-- Header simples com identidade -->
<header class="bg-white border-b border-gray-200">
    <div class="max-w-3xl mx-auto px-4 py-4 flex items-center gap-3">
        <div class="w-8 h-8 rounded bg-green-700"></div>
        <div>
            <h1 class="text-lg font-bold text-gray-900">Guia Rancho Queimado</h1>
            <p class="text-xs text-gray-600">Verifica√ß√£o de Ticket</p>
        </div>
    </div>
</header>

<main class="max-w-3xl mx-auto px-4 py-8">
    <!-- Estado: carregando -->
    <div id="loading" class="bg-white rounded-xl shadow p-6 mb-6">
        <p class="text-gray-700">Carregando dados do ticket...</p>
        <div class="mt-3 h-2 w-32 bg-gray-200 rounded overflow-hidden">
            <div class="h-full w-1/2 bg-green-600 animate-pulse"></div>
        </div>
    </div>

    <!-- Estado: ticket v√°lido -->
    <section id="card" class="bg-white p-8 rounded-xl shadow w-full hidden" aria-live="polite">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-3 h-3 bg-green-600 rounded-full"></div>
            <h2 class="text-2xl font-bold text-green-700">Ticket v√°lido ‚úÖ</h2>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-gray-50 rounded p-4">
                <p class="text-sm text-gray-500">Cliente</p>
                <p id="nomeCliente" class="text-gray-900 font-medium">-</p>
            </div>
            <div class="bg-gray-50 rounded p-4">
                <p class="text-sm text-gray-500">CPF</p>
                <p id="cpfCliente" class="text-gray-900 font-medium">-</p>
            </div>
            <div class="bg-gray-50 rounded p-4">
                <p class="text-sm text-gray-500">Ticket</p>
                <p id="nomeTicket" class="text-gray-900 font-medium">-</p>
            </div>
            <div class="bg-gray-50 rounded p-4">
                <p class="text-sm text-gray-500">Status</p>
                <p id="statusTicket" class="text-gray-900 font-medium">PAGO</p>
            </div>
        </div>

        <div class="space-y-3">
            <button
                    id="btnConfirmar"
                    type="button"
                    class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
                    onclick="confirmarTicket()"
            >
                Confirmar uso do ticket (Comerciante)
            </button>
            <p class="text-xs text-gray-600 text-center">
                Ao confirmar, este ticket ser√° marcado como usado e n√£o poder√° ser reutilizado.
            </p>
        </div>
    </section>

    <!-- Estado: ticket j√° usado -->
    <section id="usado" class="bg-yellow-50 border border-yellow-200 text-yellow-900 p-8 rounded-xl shadow w-full hidden" aria-live="polite">
        <div class="flex items-center gap-3 mb-2">
            <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
            <h2 class="text-xl font-bold">Ticket j√° validado ‚ö†Ô∏è</h2>
        </div>
        <p class="mb-4">Este ticket j√° foi utilizado anteriormente.</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white rounded p-4">
                <p class="text-sm text-gray-500">Cliente</p>
                <p id="nomeClienteUsado" class="text-gray-900 font-medium">-</p>
            </div>
            <div class="bg-white rounded p-4">
                <p class="text-sm text-gray-500">Ticket</p>
                <p id="nomeTicketUsado" class="text-gray-900 font-medium">-</p>
            </div>
        </div>
    </section>

    <!-- Estado: erro / suporte -->
    <section id="erro" class="bg-blue-50 border border-blue-200 text-blue-900 p-8 rounded-xl shadow w-full hidden" aria-live="polite">
        <div class="flex items-center gap-3 mb-2">
            <div class="w-3 h-3 bg-blue-600 rounded-full"></div>
            <h2 class="text-xl font-bold">Valida√ß√£o manual üöß</h2>
        </div>
        <p class="mb-4">N√£o foi poss√≠vel validar automaticamente este ticket. Voc√™ pode solicitar valida√ß√£o manual pelo WhatsApp.</p>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div class="bg-white rounded p-4">
                <p class="text-sm text-gray-500">Cliente</p>
                <p id="nomeClienteErro" class="text-gray-900 font-medium">-</p>
            </div>
            <div class="bg-white rounded p-4">
                <p class="text-sm text-gray-500">CPF</p>
                <p id="cpfClienteErro" class="text-gray-900 font-medium">-</p>
            </div>
        </div>

        <a
                id="btnWhatsapp"
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center justify-center gap-2 w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2"
        >
            Validar via WhatsApp
        </a>

        <p class="text-xs text-blue-700 mt-4">
            Dica: verifique se o QR token foi lido corretamente ou tente novamente.
        </p>
    </section>
</main>

<script>
    const API_BASE = "https://guia-rq-backend.onrender.com";
    const params = new URLSearchParams(window.location.search);
    const qr = params.get("qr");

    // Util: alterna visibilidade de se√ß√µes
    function showSection(id) {
      for (const el of ["loading", "card", "usado", "erro"]) {
        document.getElementById(el).classList.add("hidden");
      }
      document.getElementById(id).classList.remove("hidden");
    }

    // Util: preenche WhatsApp
    function configurarWhatsapp(nome, cpf) {
      const numeroWhatsapp = "5548999116344";
      const mensagem = `Ol√°, gostaria de validar um ticket do Guia Rancho Queimado.%0A%0ANome: ${encodeURIComponent(nome || "-")}%0ACPF: ${encodeURIComponent(cpf || "-")}`;
      const link = `https://api.whatsapp.com/send?phone=${numeroWhatsapp}&text=${mensagem}`;
      const btn = document.getElementById("btnWhatsapp");
      btn.href = link;
    }

    // Carrega dados pelo qrToken
    async function carregarTicket() {
      if (!qr) {
        // Sem token ‚Üí erro + suporte
        showSection("erro");
        configurarWhatsapp("-", "-");
        return;
      }

      showSection("loading");

      try {
        const res = await fetch(`${API_BASE}/api/ticket/${qr}`, { method: "GET" });
        if (!res.ok) throw new Error("Ticket n√£o encontrado");
        const ticket = await res.json();

        const nome = ticket.nomeCliente || "-";
        const cpf = ticket.cpfCliente || "-";
        const nomeTicket = ticket.nomeTicket || ticket.nome || "-";
        const status = ticket.status || "PAGO";

        if (ticket.usado === true) {
          // j√° utilizado
          document.getElementById("nomeClienteUsado").innerText = nome;
          document.getElementById("nomeTicketUsado").innerText = nomeTicket;
          showSection("usado");
          return;
        }

        // v√°lido e n√£o usado
        document.getElementById("nomeCliente").innerText = nome;
        document.getElementById("cpfCliente").innerText = cpf;
        document.getElementById("nomeTicket").innerText = nomeTicket;
        document.getElementById("statusTicket").innerText = status;

        showSection("card");
      } catch (e) {
        // erro / inv√°lido
        document.getElementById("nomeClienteErro").innerText = "-";
        document.getElementById("cpfClienteErro").innerText = "-";
        configurarWhatsapp("-", "-");
        showSection("erro");
      }
    }

    // Confirma uso do ticket (comerciante)
    let confirmando = false;
    async function confirmarTicket() {
      if (confirmando) return;
      confirmando = true;

      const btn = document.getElementById("btnConfirmar");
      const original = btn.innerText;
      btn.innerText = "Confirmando...";
      btn.disabled = true;

      try {
        const res = await fetch(`${API_BASE}/api/ticket/verify?token=${encodeURIComponent(qr)}`, {
          method: "POST"
        });
        const texto = await res.text();

        if (res.status === 200) {
          alert("‚úî " + (texto || "Ticket confirmado com sucesso."));
          // Atualiza tela para estado 'usado'
          const nome = document.getElementById("nomeCliente").innerText.trim() || "-";
          const ticketNome = document.getElementById("nomeTicket").innerText.trim() || "-";
          document.getElementById("nomeClienteUsado").innerText = nome;
          document.getElementById("nomeTicketUsado").innerText = ticketNome;
          showSection("usado");
        } else if (res.status === 409) {
          // j√° usado
          showSection("usado");
        } else {
          // erro ‚Üí suporte
          configurarWhatsapp(
            document.getElementById("nomeCliente").innerText.trim() || "-",
            document.getElementById("cpfCliente").innerText.trim() || "-"
          );
          showSection("erro");
        }
      } catch (err) {
        alert("‚ùå Erro de conex√£o com o servidor.");
      } finally {
        btn.innerText = original;
        btn.disabled = false;
        confirmando = false;
      }
    }

    // Inicializa
    carregarTicket();

    // Exponho para o onclick do bot√£o
    window.confirmarTicket = confirmarTicket;
</script>
</body>
</html>