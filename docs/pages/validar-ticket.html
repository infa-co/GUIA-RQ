<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.tailwindcss.com"></script>
    <title>Validar Ticket - Guia RQ</title>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">

<!-- CARD PRINCIPAL – JÁ COMEÇA VISÍVEL -->
<div id="card" class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">

    <!-- STATUS VISUAL -->
    <div class="flex flex-col items-center mb-4">
        <div class="w-16 h-16 bg-green-100 text-green-700 flex items-center justify-center rounded-full mb-3">
            <span class="text-4xl">✔</span>
        </div>
        <h1 class="text-2xl font-bold text-gray-800">Ticket Válido</h1>
        <p class="text-gray-600 mt-1 text-sm">
            Confirme os dados abaixo para registrar o uso deste ticket.
        </p>
    </div>

    <hr class="my-4">

    <!-- INFORMAÇÕES DO TICKET -->
    <div class="text-left mb-4">
        <p class="text-gray-700 mb-1">
            <strong>Cliente original:</strong> <span id="nomeCliente">—</span>
        </p>
        <p class="text-gray-700 mb-1">
            <strong>Ticket:</strong> <span id="nomeTicket">—</span>
        </p>
        <p id="pacoteInfo" class="text-blue-700 font-semibold mt-2 hidden"></p>
    </div>

    <hr class="my-4">

    <!-- FORMULÁRIO DO ESTABELECIMENTO -->
    <div class="text-left">
        <label class="block mb-1 font-semibold">Nome do cliente que está usando agora</label>
        <input id="clienteUso" type="text" class="w-full p-2 border rounded mb-3" placeholder="Ex.: João da Silva">

        <label class="block mb-1 font-semibold">Nome do estabelecimento</label>
        <input id="estabelecimento" type="text" class="w-full p-2 border rounded mb-3" placeholder="Ex.: Cafeteria da Serra">

        <label class="block mb-1 font-semibold">Validado por (funcionário)</label>
        <input id="validadoPor" type="text" class="w-full p-2 border rounded mb-3" placeholder="Ex.: Carla">
    </div>

    <button
            onclick="confirmarTicket()"
            id="btnConfirmar"
            class="mt-6 w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
        Confirmar uso do ticket
    </button>
</div>

<script>
    // Assim que a página carrega, fazemos só o básico
    (function () {
        const params = new URLSearchParams(window.location.search);
        const qr = params.get("qr");

        // Deixa o qr acessível na função de confirmar
        window._qrToken = qr || null;

        // Se quiser puxar informações depois, dá pra plugar aqui.
        // Por enquanto, deixamos fixo como visualmente válido.
        // Exemplo: se no futuro o backend devolver os dados, é só preencher:
        //
        // document.getElementById("nomeCliente").innerText = ticket.cliente;
        // document.getElementById("nomeTicket").innerText = ticket.ticket;
        //
        // Agora vamos só garantir que a tela aparece sempre.
    })();

    function confirmarTicket() {
        const clienteUso = document.getElementById("clienteUso").value.trim();
        const estabelecimento = document.getElementById("estabelecimento").value.trim();
        const validadoPor = document.getElementById("validadoPor").value.trim();
        const qr = window._qrToken;

        if (!clienteUso || !estabelecimento || !validadoPor) {
            alert("Preencha todos os campos antes de confirmar.");
            return;
        }

        // Caso não tenha QR (ex: acesso manual), só registra visualmente
        if (!qr) {
            alert("✔ Ticket confirmado (registro manual, sem QR).");
            return;
        }

        // Aqui sim chamamos o backend para registrar o uso real
        fetch(`https://guia-rq-backend.onrender.com/api/tickets/confirmar/${qr}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                clienteUso,
                estabelecimento,
                validadoPor
            })
        })
            .then(async (res) => {
                const texto = await res.text();

                if (res.status === 200) {
                    alert("✔ " + (texto || "Ticket confirmado com sucesso."));
                    location.reload();
                } else if (res.status === 409) {
                    alert("⚠ Este ticket já foi utilizado.");
                } else if (res.status === 404) {
                    alert("❌ Ticket não encontrado no sistema.");
                } else {
                    alert("❌ Não foi possível confirmar o ticket.");
                }
            })
            .catch(() => {
                alert("❌ Erro de conexão com o servidor.");
            });
    }
</script>

</body>
</html>
