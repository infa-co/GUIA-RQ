<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+dl:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PF2TSPV6');</script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { display: none; }
    </style>

    <title>Finalizar Compra - Guia RQ</title>
</head>

<body class="bg-gray-50 overflow-y-auto min-h-screen">

<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PF2TSPV6"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<header id="header" class="bg-white shadow-sm fixed top-0 w-full z-50">
    <div class="px-4 py-3 flex items-center justify-between">
        <a href="../index.html" class="flex items-center space-x-2 group">
            <img src="../assets/images/guia-rancho-queimado-logo-sem-fundo.png"
                 alt="Logo Guia RQ"
                 class="h-12 sm:h-14 w-auto transition-transform group-hover:scale-105">
            <span class="text-lg sm:text-xl font-semibold text-gray-800 group-hover:text-blue-600 transition-colors">
                Guia RQ
            </span>
        </a>
    </div>
</header>

<main id="main-content" class="pt-20 pb-32 overflow-y-auto">

    <section id="order-summary" class="bg-white border-b border-gray-100">
        <div id="order-content" class="px-4 py-4"></div>
    </section>

    <section id="personal-data" class="px-4 py-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Dados Pessoais</h2>
        <p class="text-sm text-gray-600 mb-4">Preencha seus dados para finalizar a reserva</p>
        <form id="personal-form" class="space-y-4">
            <input type="text" placeholder="Seu nome completo" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600" id="nome">
            <input type="email" placeholder="seu@email.com" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600" id="email">
            <input type="tel" placeholder="(48) 99999-9999" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600" id="telefone">
            <input type="tel" placeholder="999.999.999-99" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600" id="cpf">
        </form>
    </section>

    <section id="payment-methods" class="px-4 py-6 bg-white">

        <h2 class="text-lg font-semibold text-gray-900 mb-4">M√©todo de Pagamento</h2>

        <div class="space-y-3">

            <!-- CART√ÉO -->
            <div class="payment-option border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:border-blue-600 transition" onclick="selectPayment('credit', event)">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-credit-card text-blue-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">Cart√£o de Cr√©dito</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="credit-card-form" class="hidden mt-4 bg-gray-50 p-4 rounded-xl space-y-3">
                <input type="text" placeholder="N√∫mero do cart√£o" maxlength="16" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600">
                <div class="flex space-x-3">
                    <input type="text" placeholder="MM/AA" class="w-1/2 px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600">
                    <input type="text" placeholder="CVV" maxlength="3" class="w-1/2 px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600">
                </div>
                <button id="save-card" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition">Salvar Cart√£o</button>
                <p id="card-saved" class="hidden text-green-600 text-sm font-medium text-center mt-2">
                    <i class="fa-solid fa-check mr-1"></i> Cart√£o salvo com sucesso!
                </p>
            </div>

            <!-- ‚ùå REMOVIDO: OP√á√ÉO PIX  -->

            <!-- CARTEIRA DIGITAL -->
            <div class="payment-option border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:border-blue-600 transition" onclick="selectPayment('wallet', event)">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-wallet text-gray-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">Carteira Digital</div>
                            <div class="text-sm text-gray-600">Apple Pay, Google Pay</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center justify-center bg-black text-white px-2.5 py-1 rounded-md text-[13px] font-semibold">Ô£ø Pay</div>
                        <div class="flex items-center justify-center bg-[#4285F4] text-white px-2.5 py-1 rounded-md text-[13px] font-semibold">G Pay</div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<div id="checkout-footer" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-[60] shadow-lg">
    <button id="pay-btn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-semibold text-base hover:bg-blue-700 transition">
        Finalizar Compra
    </button>
</div>

<script>
    if (!window.API_URL) {
        window.API_URL = "https://guia-rq-backend.onrender.com";
    }

    const nomeInput = document.getElementById("nome");
    const emailInput = document.getElementById("email");
    const telefoneInput = document.getElementById("telefone");
    const cpfInput = document.getElementById("cpf");
    const payBtn = document.getElementById("pay-btn");

    function validarDados(nome, email, telefone, cpf) {
        return nome && email && telefone && cpf;
    }

    function isCompraPacote(descricao) {
        return descricao?.toLowerCase().trim() === "pacote completo guia rq";
    }

    payBtn.addEventListener("click", async () => {
        payBtn.disabled = true;
        payBtn.textContent = "Processando...";

        try {
            const nome = nomeInput.value.trim();
            const email = emailInput.value.trim();
            const telefone = telefoneInput.value.trim();
            const cpf = cpfInput.value.trim();

            if (!validarDados(nome, email, telefone, cpf)) {
                alert("Preencha todos os dados antes de continuar.");
                return;
            }

            const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
            const resumo = JSON.parse(localStorage.getItem("resumoCompra")) || {};

            if (!carrinho.length) {
                alert("Seu carrinho est√° vazio.");
                return;
            }

            const total = Number(resumo.totalFinal);

            const item = carrinho[0];
            const descricao = item?.nome || "Compra de ingresso(s) ‚Äì Guia Rancho Queimado";
            const isPacote = isCompraPacote(descricao);

            const ticketId = item?.id || null;
            const quantidade = item?.quantidade || 1;

            console.log("üì¶ Tipo de compra:", isPacote ? "Pacote" : "Ticket avulso");
            console.log("‚û°Ô∏è Enviando para Stripe:", {
                amount: total,
                description: descricao,
                nome,
                email,
                telefone,
                cpf,
                pacote: isPacote,
                ticketId,
                quantidade
            });

            const response = await fetch(`${window.API_URL}/api/stripe/create-checkout`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    amount: total,
                    description: descricao,
                    nome,
                    email,
                    telefone,
                    cpf,
                    pacote: isPacote,
                    ticketId,
                    quantidade
                })
            });

            const data = await response.json();
            if (!data.url) throw new Error("URL de checkout n√£o recebida.");

            window.location.href = data.url;

        } catch (err) {
            console.error("Erro ao iniciar pagamento:", err);
            alert("Erro ao iniciar pagamento. Recarregue a p√°gina e tente novamente.");
        } finally {
            payBtn.disabled = false;
            payBtn.textContent = "Pagar";
        }
    });
</script>
</body>
</html>
