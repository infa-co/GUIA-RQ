<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+dl:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-PF2TSPV6');</script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { display: none; }
    </style>

    <title>Finalizar Compra - Guia RQ</title>
</head>

<body class="bg-gray-50 overflow-y-auto min-h-screen">

<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-PF2TSPV6"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<header id="header" class="bg-white shadow-sm fixed top-0 w-full z-50">
    <div class="px-4 py-3 flex items-center justify-between">
        <a href="../index.html" class="flex items-center space-x-2 group">
            <img src="../assets/images/guia-rancho-queimado-logo-sem-fundo.png"
                 alt="Logo Guia RQ"
                 class="h-12 sm:h-14 w-auto transition-transform group-hover:scale-105">
            <span class="text-lg sm:text-xl font-semibold text-gray-800 group-hover:text-blue-600 transition-colors">
                Guia RQ
            </span>
        </a>
    </div>
</header>

<main id="main-content" class="pt-20 pb-32 overflow-y-auto">

    <section id="order-summary" class="bg-white border-b border-gray-100">
        <div id="order-content" class="px-4 py-4"></div>
    </section>

    <section id="personal-data" class="px-4 py-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Dados Pessoais</h2>
        <p class="text-sm text-gray-600 mb-4">Preencha seus dados para finalizar a reserva</p>
        <form id="personal-form" class="space-y-4">
            <input type="text" placeholder="Seu nome completo" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600" id="nome">
            <input type="email" placeholder="seu@email.com" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600" id="email">
            <input type="tel" placeholder="(48) 99999-9999" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600" id="telefone">
        </form>
    </section>

    <section id="payment-methods" class="px-4 py-6 bg-white">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Método de Pagamento</h2>

        <div class="space-y-3">

            <!-- CARTÃO -->
            <div class="payment-option border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:border-blue-600 transition" onclick="selectPayment('credit', event)">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-blue-50 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-credit-card text-blue-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">Cartão de Crédito</div>
                            <div class="text-sm text-gray-600">Até 12x sem juros</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="credit-card-form" class="hidden mt-4 bg-gray-50 p-4 rounded-xl space-y-3">
                <input type="text" placeholder="Número do cartão" maxlength="16" class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600">
                <div class="flex space-x-3">
                    <input type="text" placeholder="MM/AA" class="w-1/2 px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600">
                    <input type="text" placeholder="CVV" maxlength="3" class="w-1/2 px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-600">
                </div>
                <button id="save-card" class="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition">Salvar Cartão</button>
                <p id="card-saved" class="hidden text-green-600 text-sm font-medium text-center mt-2">
                    <i class="fa-solid fa-check mr-1"></i> Cartão salvo com sucesso!
                </p>
            </div>

            <!-- ❌ REMOVIDO: OPÇÃO PIX  -->

            <!-- CARTEIRA DIGITAL -->
            <div class="payment-option border-2 border-gray-200 rounded-xl p-4 cursor-pointer hover:border-blue-600 transition" onclick="selectPayment('wallet', event)">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-wallet text-gray-600"></i>
                        </div>
                        <div>
                            <div class="font-medium text-gray-900">Carteira Digital</div>
                            <div class="text-sm text-gray-600">Apple Pay, Google Pay</div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <div class="flex items-center justify-center bg-black text-white px-2.5 py-1 rounded-md text-[13px] font-semibold"> Pay</div>
                        <div class="flex items-center justify-center bg-[#4285F4] text-white px-2.5 py-1 rounded-md text-[13px] font-semibold">G Pay</div>
                    </div>
                </div>
            </div>

        </div>
    </section>

    <section id="upsell" class="px-4 py-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-1">Antes de finalizar, adicione e ganhe mais benefícios</h2>
        <p class="text-sm text-gray-600 mb-3">Ofertas especiais por tempo limitado</p>
        <div class="border border-gray-200 rounded-xl p-4">
            <div class="flex items-start space-x-3">
                <input type="checkbox" class="mt-1 w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <i class="fa-solid fa-percent text-success"></i>
                        <span class="font-medium text-gray-900 text-sm">Leve mais um Ticket surpresa com garantia de 100% de retorno</span>
                        <span class="bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded-full font-medium">+R$ 22</span>
                    </div>
                    <p class="text-xs text-gray-600">Cupom válido por 1 ano para sua próxima experiência no Guia RQ</p>
                </div>
            </div>
        </div>
    </section>
</main>

<div id="checkout-footer" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 z-[60] shadow-lg">
    <button id="pay-btn" class="w-full bg-blue-600 text-white py-4 rounded-xl font-semibold text-base hover:bg-blue-700 transition">
        Finalizar Compra
    </button>
</div>

<script>

    // fallback
    if (!window.API_URL) {
        window.API_URL = "https://guia-rq-backend.onrender.com";
    }

    // NADA ALTERADO AQUI ↓↓↓

    // ====== BOTÃO FINALIZAR COMPRA → CHAMA BACKEND STRIPE ======
    const payBtn = document.getElementById("pay-btn");

    payBtn.addEventListener("click", async () => {
        try {
            const carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
            const resumo   = JSON.parse(localStorage.getItem("resumoCompra")) || {};

            if (!carrinho.length) {
                alert("Seu carrinho está vazio.");
                return;
            }

            const total = Number(resumo.totalFinal);
            if (!total || isNaN(total)) {
                console.error("Resumo inválido:", resumo);
                alert("Erro ao calcular o valor da compra. Tente novamente.");
                return;
            }

            console.log("Iniciando checkout Stripe...");

            const response = await fetch("https://guia-rq-backend.onrender.com/api/stripe/create-checkout", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    amount: total * 100,
                    description: "Compra de ingresso(s) – Guia Rancho Queimado",
                    email: resumo.email
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                console.error("Erro Stripe:", errorText);
                throw new Error("Falha ao criar sessão de pagamento.");
            }

            const data = await response.json();

            if (!data.url) {
                console.error("Resposta inválida:", data);
                throw new Error("URL de checkout não recebida.");
            }

            window.location.href = data.url;

        } catch (err) {
            console.error("Erro ao iniciar pagamento:", err);
            alert("Erro ao iniciar pagamento. Recarregue a página e tente novamente.");
        }
    });
</script>
</body>
</html>
